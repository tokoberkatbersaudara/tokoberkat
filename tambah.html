<script defer>
  window.onload = async () => {
    const SUPABASE_URL = 'https://uorlbeapdkgrnxvttbus.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJI...'; // Tetap aman selama hanya digunakan di public apps
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const params = new URLSearchParams(window.location.search);
    const editId = params.get("id");

    const form = document.getElementById('form-tambah');
    const nama = document.getElementById('nama');
    const kode = document.getElementById('kode');
    const jumlah = document.getElementById('jumlah');
    const harga = document.getElementById('harga');
    const stok_minimum = document.getElementById('stok_minimum');

    // Jika mode edit, ambil data dari Supabase dan isi form
    if (editId) {
      const { data, error } = await supabase.from('products').select('*').eq('id', editId).single();
      if (data) {
        nama.value = data.nama;
        kode.value = data.kode;
        jumlah.value = data.jumlah;
        harga.value = data.harga;
        stok_minimum.value = data.stok_minimum || 0;
      } else {
        alert("❌ Gagal memuat data untuk diedit.");
        console.error(error);
        return;
      }
    }

    // Submit form
    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      const payload = {
        nama: nama.value.trim(),
        kode: kode.value.trim(),
        jumlah: parseInt(jumlah.value),
        harga: parseInt(harga.value),
        stok_minimum: parseInt(stok_minimum.value)
      };

      let result;
      if (editId) {
        result = await supabase.from('products').update(payload).eq('id', editId);
      } else {
        result = await supabase.from('products').insert([payload]);
      }

      if (result.error) {
        alert("❌ Gagal menyimpan data.");
        console.error(result.error);
      } else {
        alert(`✅ Barang berhasil ${editId ? 'diubah' : 'ditambahkan'}.`);
        window.location.href = 'stok.html';
      }
    });
  };
</script>